<!DOCTYPE html>
<html>
<head>
<title>Simple Ordering System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; max-width:700px; margin:auto; padding:15px;}
input, select, button { width:100%; padding:10px; margin:5px 0;}
button { background:#2c7be5; color:white; border:none; border-radius:5px; cursor:pointer;}
button:hover { opacity:0.9; }
.card { border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:6px;}
.hidden { display:none;}
</style>
</head>
<body>

<h2>Simple Ordering System</h2>

<button onclick="showTab('stock')">Stock</button>
<button onclick="showTab('orders')">Orders</button>

<div id="stock">

<h3>Add Stock</h3>
<input id="itemName" placeholder="Item Name">
<input type="number" id="itemQty" placeholder="Quantity">
<input type="number" id="itemPrice" placeholder="Price (RM)">
<button onclick="addStock()">Save</button>

<h3>Stock List</h3>
<div id="stockList"></div>

<h3>Create Order</h3>
<input id="customer" placeholder="Customer Name">
<select id="orderItem"></select>
<input type="number" id="orderQty" placeholder="Quantity">
<button onclick="addOrder()">Submit Order</button>

<select id="payment">
<option>Paid</option>
<option>Unpaid</option>
</select>

</div>

<div id="orders" class="hidden">
<h3>Orders</h3>
<div id="orderList"></div>
<h3>Total Revenue</h3>
<div id="revenue"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore,
collection,
addDoc,
updateDoc,
deleteDoc,
doc,
onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyASU5pOnnFL-LrltouQiw5swlUFvqLsa7c",
  authDomain: "order-kuih-raya.firebaseapp.com",
  projectId: "order-kuih-raya",
  storageBucket: "order-kuih-raya.firebasestorage.app",
  messagingSenderId: "158401610821",
  appId: "1:158401610821:web:34b094d400e947ec350f2c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cart = [];

/* TAB SWITCH */
window.showTab = function(tab){
document.getElementById("stock").classList.add("hidden");
document.getElementById("orders").classList.add("hidden");
document.getElementById(tab).classList.remove("hidden");
}

/* ADD STOCK */
window.addStock = async function(){

let name = itemName.value.trim();
let qty = parseInt(itemQty.value);
let price = parseFloat(itemPrice.value);

if(!name || isNaN(qty) || isNaN(price)){
alert("Fill all fields");
return;
}

await addDoc(collection(db,"stock"),{
name,
qty,
price
});

itemName.value="";
itemQty.value="";
itemPrice.value="";
};

/* REALTIME STOCK */
onSnapshot(collection(db,"stock"), snapshot=>{

stockList.innerHTML="";
orderItem.innerHTML="";

snapshot.forEach(d=>{
let data=d.data();

stockList.innerHTML+=`
<div class="card">
${data.name}<br>
Qty: ${data.qty}<br>
Price: RM ${data.price}
</div>`;

orderItem.innerHTML+=`
<option value="${d.id}|${data.name}|${data.price}">
${data.name}
</option>`;
});
});

/* ADD ORDER (NO TRANSACTION) */
window.addOrder = async function(){

let selected = orderItem.value.split("|");
let id = selected[0];
let name = selected[1];
let price = parseFloat(selected[2]);
let qty = parseInt(orderQty.value);
let customerName = customer.value.trim();
let paymentStatus = payment.value;

if(!customerName || isNaN(qty)){
alert("Fill all fields");
return;
}

let total = price * qty;

// Deduct stock directly
const stockRef = doc(db,"stock",id);

await updateDoc(stockRef,{
qty: qty * -1
}).catch(()=>{});

await addDoc(collection(db,"orders"),{
customer: customerName,
item: name,
qty,
total,
payment: paymentStatus,
date: new Date()
});

customer.value="";
orderQty.value="";
};

/* REALTIME ORDERS */
onSnapshot(collection(db,"orders"), snapshot=>{

orderList.innerHTML="";
let revenue=0;

snapshot.forEach(d=>{
let data=d.data();

if(data.payment==="Paid"){
revenue+=data.total;
}

orderList.innerHTML+=`
<div class="card">
${data.customer}<br>
${data.item}<br>
Qty: ${data.qty}<br>
Total: RM ${data.total}<br>
Status: ${data.payment}
</div>`;
});

revenueDiv.innerHTML="RM "+revenue.toFixed(2);
});

</script>
</body>
</html>
