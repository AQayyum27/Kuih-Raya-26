<!DOCTYPE html>
<html>
<head>
<title>Personal Ordering System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; max-width:700px; margin:auto; padding:15px;}
input, select, button { width:100%; padding:10px; margin:5px 0;}
button { background:#2c7be5; color:white; border:none; border-radius:5px; cursor:pointer;}
button:hover { opacity:0.9; }
.card { border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:6px;}
.hidden { display:none;}
.flex { display:flex; gap:5px;}
.small-btn { width:auto; padding:5px 10px; margin-top:5px; background:#28a745;}
.delete-btn { background:#dc3545;}
.tab-btn { flex:1; }
</style>
</head>
<body>

<h2>Personal Ordering System</h2>

<div class="flex">
<button class="tab-btn" id="stockTabBtn">Stock</button>
<button class="tab-btn" id="ordersTabBtn">Orders</button>
</div>

<div id="stockSection">

<h3>Add Stock</h3>
<input id="itemName" placeholder="Item Name">
<input type="number" id="itemQty" placeholder="Quantity">
<input type="number" id="itemPrice" placeholder="Price (RM)">
<button id="saveStockBtn">Save Stock</button>

<h3>Current Stock</h3>
<div id="stockList"></div>

<h3>Create Order</h3>
<input id="customer" placeholder="Customer Name">
<select id="orderItem"></select>
<input type="number" id="orderQty" placeholder="Quantity">
<button id="addCartBtn">Add To Cart</button>

<div id="cart"></div>

<select id="payment">
<option>Paid</option>
<option>Unpaid</option>
</select>

<button id="submitOrderBtn">Submit Order</button>

</div>

<div id="ordersSection" class="hidden">
<h3>Orders</h3>
<div id="orderList"></div>

<h3>Total Paid Revenue</h3>
<div id="totalRevenue">RM 0.00</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore,
collection,
addDoc,
doc,
updateDoc,
deleteDoc,
onSnapshot,
runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyASU5pOnnFL-LrltouQiw5swlUFvqLsa7c",
  authDomain: "order-kuih-raya.firebaseapp.com",
  projectId: "order-kuih-raya",
  storageBucket: "order-kuih-raya.firebasestorage.app",
  messagingSenderId: "158401610821",
  appId: "1:158401610821:web:34b094d400e947ec350f2c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cartItems = [];

/* ---------------- TABS ---------------- */

document.getElementById("stockTabBtn").onclick = () => {
document.getElementById("stockSection").classList.remove("hidden");
document.getElementById("ordersSection").classList.add("hidden");
};

document.getElementById("ordersTabBtn").onclick = () => {
document.getElementById("ordersSection").classList.remove("hidden");
document.getElementById("stockSection").classList.add("hidden");
};

/* ---------------- ADD STOCK ---------------- */

document.getElementById("saveStockBtn").onclick = async () => {

let name = itemName.value.trim();
let qty = parseInt(itemQty.value);
let price = parseFloat(itemPrice.value);

if(!name || isNaN(qty) || isNaN(price)){
alert("Fill all fields");
return;
}

try {
await addDoc(collection(db,"stock"),{ name, qty, price });
itemName.value="";
itemQty.value="";
itemPrice.value="";
alert("Stock saved");
} catch(error){
alert(error.message);
}
};

/* ---------------- REALTIME STOCK ---------------- */

onSnapshot(collection(db,"stock"), snapshot => {

stockList.innerHTML="";
orderItem.innerHTML="";

snapshot.forEach(docSnap => {

let data = docSnap.data();

stockList.innerHTML += `
<div class="card">
<strong>${data.name}</strong><br>
Qty: ${data.qty}<br>
Price: RM ${data.price}
</div>`;

orderItem.innerHTML += `
<option value="${docSnap.id}|${data.name}|${data.price}">
${data.name}
</option>`;
});

});

/* ---------------- CART ---------------- */

document.getElementById("addCartBtn").onclick = () => {

let selected = orderItem.value.split("|");
if(selected.length < 3) return;

let id = selected[0];
let name = selected[1];
let price = parseFloat(selected[2]);
let qty = parseInt(orderQty.value);

if(isNaN(qty) || qty <= 0){
alert("Enter valid quantity");
return;
}

cartItems.push({id,name,price,qty});
orderQty.value="";
renderCart();
};

function renderCart(){

cart.innerHTML="";
let total=0;

cartItems.forEach((item,index)=>{
let itemTotal = item.price * item.qty;
total += itemTotal;

cart.innerHTML += `
<div class="card">
${item.name} | Qty: ${item.qty} | RM ${itemTotal}
<button class="delete-btn small-btn" onclick="removeCart(${index})">X</button>
</div>`;
});

cart.innerHTML += `<strong>Total: RM ${total.toFixed(2)}</strong>`;
}

window.removeCart = function(index){
cartItems.splice(index,1);
renderCart();
};

/* ---------------- SUBMIT ORDER ---------------- */

document.getElementById("submitOrderBtn").onclick = async () => {

let customerName = customer.value.trim();
let paymentStatus = payment.value;

if(!customerName || cartItems.length === 0){
alert("Add items first");
return;
}

try {

await runTransaction(db, async (transaction)=>{

let total = 0;

for(let item of cartItems){

let stockRef = doc(db,"stock",item.id);
let stockDoc = await transaction.get(stockRef);

if(!stockDoc.exists()){
throw new Error("Item not found");
}

let stockData = stockDoc.data();

if(stockData.qty < item.qty){
throw new Error("Not enough stock for " + item.name);
}

transaction.update(stockRef,{
qty: stockData.qty - item.qty
});

total += item.price * item.qty;
}

const newOrderRef = doc(collection(db,"orders"));

transaction.set(newOrderRef,{
customer: customerName,
items: cartItems,
total,
payment: paymentStatus,
date: new Date()
});

});

cartItems=[];
renderCart();
customer.value="";
alert("Order Submitted");

} catch(error){
alert(error.message);
console.error(error);
}

};

/* ---------------- REALTIME ORDERS ---------------- */

onSnapshot(collection(db,"orders"), snapshot => {

orderList.innerHTML="";
let revenue=0;

snapshot.forEach(docSnap => {

let data = docSnap.data();

if(data.payment === "Paid"){
revenue += data.total;
}

let itemsHTML="";
data.items.forEach(i=>{
itemsHTML += `${i.name} (x${i.qty})<br>`;
});

orderList.innerHTML += `
<div class="card">
<strong>${data.customer}</strong><br>
${itemsHTML}
Total: RM ${data.total}<br>
Status: ${data.payment}<br>
<button class="small-btn" onclick="togglePayment('${docSnap.id}','${data.payment}')">Toggle Payment</button>
<button class="delete-btn small-btn" onclick="deleteOrder('${docSnap.id}')">Delete</button>
</div>`;
});

totalRevenue.innerHTML = "RM " + revenue.toFixed(2);

});

/* ---------------- TOGGLE PAYMENT ---------------- */

window.togglePayment = async (id,status)=>{
let newStatus = status==="Paid" ? "Unpaid" : "Paid";
await updateDoc(doc(db,"orders",id),{ payment:newStatus });
};

/* ---------------- DELETE ORDER ---------------- */

window.deleteOrder = async (id)=>{

let orderRef = doc(db,"orders",id);

try {

await runTransaction(db, async (transaction)=>{

let orderDoc = await transaction.get(orderRef);
if(!orderDoc.exists()) return;

let data = orderDoc.data();

for(let item of data.items){
let stockRef = doc(db,"stock",item.id);
let stockDoc = await transaction.get(stockRef);

let stockData = stockDoc.data();

transaction.update(stockRef,{
qty: stockData.qty + item.qty
});
}

transaction.delete(orderRef);

});

} catch(error){
alert(error.message);
}

};

</script>
</body>
</html>
